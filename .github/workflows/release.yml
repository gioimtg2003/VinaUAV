name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  publish-app:
    permissions:
      contents: write
    runs-on: windows-latest
    steps:
        - name: Checkout code
          uses: actions/checkout@v2

        - name:  Install Rust stable
          uses: actions-rs/toolchain@v1
          with:
              toolchain: stable
              target: x86_64-pc-windows-msvc
              override: true

        #  Cargo use all CPU to build => use large RAM
        - name: Rust Cache
          uses: swatinem/rust-cache@v2
          with:
            workspaces: "src-tauri -> target"


        - name: Setup Bun
          uses: oven-sh/setup-bun@v2

        - name: Install Dependencies
          run: bun install

        - name: Build
          uses: tauri-apps/tauri-action@v0
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
            TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

          with:
              runner: bun
              tagName: v__VERSION__
              releaseName: "Vina UAV v__VERSION__"
              releaseBody: |
                          ## VinaUAV Windows Release
                          See the assets below to download and install this version.

                          ## Installation
                          - **Windows**: Download the `.msi` or `.exe` installer

                          The app includes automatic updates - future updates will be installed automatically.

              releaseDraft: true
              prerelease: false
              args: "--bundles nsis,msi"
              includeUpdaterJson: true

        - name: Upload Artifacts
          uses: actions/upload-artifact@v4
          with:
              name: VinaUAV-Windows-Build
              path: src-tauri/target/release/bundle/
